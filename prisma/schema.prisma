// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// AUTENTICACIÓN Y AUTORIZACIÓN
// ============================================
enum Role {
  ADMIN
  MODERATOR
  VISITOR
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          Role      @default(VISITOR)
  banned        Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts        Account[]
  sessions        Session[]
  comments        Comment[]
  userRatings     UserRating[]
  viewStatuses    ViewStatus[]
  featureRequests FeatureRequest[]
  featureVotes    FeatureVote[]
  accessLogs      AccessLog[]
  suggestedSites  SuggestedSite[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// UNIVERSOS - Para agrupar series relacionadas
// ============================================
model Universe {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  series      Series[]
}

// ============================================
// PRODUCTORAS
// ============================================
model ProductionCompany {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  country   String?
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  series    Series[]
}

// ============================================
// IDIOMAS
// ============================================
model Language {
  id                     Int             @id @default(autoincrement())
  name                   String          @unique
  code                   String?

  seriesOriginalLanguage Series[]        @relation("OriginalLanguage")
  dubbings               SeriesDubbing[]
}

// Doblajes disponibles por serie
model SeriesDubbing {
  id         Int      @id @default(autoincrement())

  seriesId   Int
  series     Series   @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  languageId Int
  language   Language @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([seriesId, languageId])
}

// ============================================
// SERIES - Series, películas, cortos, etc.
// ============================================
model Series {
  id            Int       @id @default(autoincrement())
  title         String
  originalTitle String?
  year          Int?
  type          String    // "serie", "pelicula", "corto", "especial"
  basedOn       String?   // "libro", "novela", "corto", "manga", "anime"
  format        String    @default("regular") // "regular", "vertical"
  imageUrl      String?
  imagePosition String    @default("center") // CSS background-position
  synopsis      String?   // Sinopsis de la serie
  review        String?   // Reseña personal
  soundtrack    String?   // Banda sonora
  overallRating Int?      // Puntuación general (del Excel)
  observations  String?   // Observaciones
  isFavorite    Boolean   @default(false) // Marcado como favorito
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones
  universeId           Int?
  universe             Universe?          @relation(fields: [universeId], references: [id])
  countryId            Int?
  country              Country?           @relation(fields: [countryId], references: [id])
  productionCompanyId  Int?
  productionCompany    ProductionCompany? @relation(fields: [productionCompanyId], references: [id])
  originalLanguageId   Int?
  originalLanguage     Language?          @relation("OriginalLanguage", fields: [originalLanguageId], references: [id])

  seasons       Season[]
  actors        SeriesActor[]
  directors     SeriesDirector[]
  ratings       Rating[]
  userRatings   UserRating[]
  comments      Comment[]
  viewStatus    ViewStatus[]
  tags          SeriesTag[]
  dubbings      SeriesDubbing[]
  genres        SeriesGenre[]
  watchLinks         WatchLink[]
  embeddableContent  EmbeddableContent[]
  relatedSeriesFrom  RelatedSeries[] @relation("mainSeries")
  relatedSeriesTo    RelatedSeries[] @relation("relatedSeries")
}

// ============================================
// TEMPORADAS
// ============================================
model Season {
  id            Int       @id @default(autoincrement())
  seasonNumber  Int
  title         String?
  episodeCount  Int?      // Número de capítulos
  year          Int?
  imageUrl      String?
  synopsis      String?
  observations  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones
  seriesId      Int
  series        Series    @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  episodes      Episode[]
  actors        SeasonActor[]
  ratings       Rating[]
  comments      Comment[]
  viewStatus    ViewStatus[]

  @@unique([seriesId, seasonNumber])
}

// ============================================
// EPISODIOS (OPCIONAL)
// ============================================
model Episode {
  id            Int       @id @default(autoincrement())
  episodeNumber Int
  title         String?
  duration      Int?      // Duración en minutos
  airDate       DateTime?
  synopsis      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones
  seasonId      Int
  season        Season    @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  viewStatus    ViewStatus[] @relation("EpisodeViewStatus")
  comments      Comment[]

  @@unique([seasonId, episodeNumber])
}

// ============================================
// ACTORES
// ============================================
model Actor {
  id            Int       @id @default(autoincrement())
  name          String    @unique
  stageName     String?   // Nombre artístico
  birthDate     DateTime?
  nationality   String?
  imageUrl      String?
  biography     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  series        SeriesActor[]
  seasons       SeasonActor[]
}

// ============================================
// DIRECTORES
// ============================================
model Director {
  id            Int       @id @default(autoincrement())
  name          String    @unique
  nationality   String?
  imageUrl      String?
  biography     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  series        SeriesDirector[]
}

// ============================================
// PAÍSES
// ============================================
model Country {
  id            Int       @id @default(autoincrement())
  name          String    @unique
  code          String?   @unique // ISO code (ej: "KR", "TH", "JP")
  flagUrl       String?

  series        Series[]
}

// ============================================
// GÉNEROS
// ============================================
model Genre {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  series    SeriesGenre[]
}

// Géneros por Serie
model SeriesGenre {
  id       Int    @id @default(autoincrement())

  seriesId Int
  series   Series @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  genreId  Int
  genre    Genre  @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@unique([seriesId, genreId])
}

// ============================================
// TAGS/ETIQUETAS
// ============================================
model Tag {
  id            Int       @id @default(autoincrement())
  name          String    @unique // "Enemy to Lovers", "Friends to Lovers", etc.
  category      String?   // "trope", "genre", "mood", etc.
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  series        SeriesTag[]
}

// ============================================
// RELACIONES MUCHOS A MUCHOS
// ============================================

// Actores por Serie (general)
model SeriesActor {
  id            Int       @id @default(autoincrement())
  character     String?   // Personaje que interpreta
  isMain        Boolean   @default(false) // ¿Es protagonista?
  pairingGroup  Int?      // Actores con el mismo número forman pareja

  seriesId      Int
  series        Series    @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  actorId       Int
  actor         Actor     @relation(fields: [actorId], references: [id], onDelete: Cascade)

  @@unique([seriesId, actorId, character])
}

// Actores por Temporada (específico)
model SeasonActor {
  id            Int       @id @default(autoincrement())
  character     String?   // Personaje que interpreta
  isMain        Boolean   @default(false)

  seasonId      Int
  season        Season    @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  actorId       Int
  actor         Actor     @relation(fields: [actorId], references: [id], onDelete: Cascade)

  @@unique([seasonId, actorId, character])
}

// Directores por Serie
model SeriesDirector {
  id            Int       @id @default(autoincrement())

  seriesId      Int
  series        Series    @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  directorId    Int
  director      Director  @relation(fields: [directorId], references: [id], onDelete: Cascade)

  @@unique([seriesId, directorId])
}

// Tags/Etiquetas por Serie
model SeriesTag {
  id            Int       @id @default(autoincrement())

  seriesId      Int
  series        Series    @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  tagId         Int
  tag           Tag       @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([seriesId, tagId])
}

// ============================================
// SERIES RELACIONADAS (self-referential many-to-many)
// ============================================
model RelatedSeries {
  id              Int      @id @default(autoincrement())

  mainSeriesId    Int
  mainSeries      Series   @relation("mainSeries", fields: [mainSeriesId], references: [id], onDelete: Cascade)
  relatedSeriesId Int
  relatedSeries   Series   @relation("relatedSeries", fields: [relatedSeriesId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@unique([mainSeriesId, relatedSeriesId])
}

// ============================================
// RATINGS POR CATEGORÍA
// ============================================
model Rating {
  id            Int       @id @default(autoincrement())
  category      String    // "trama", "casting", "originalidad", "bso", etc.
  score         Int       // 1-10
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Puede ser rating de Serie o Temporada
  seriesId      Int?
  series        Series?   @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  seasonId      Int?
  season        Season?   @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  @@unique([seriesId, seasonId, category])
}

// ============================================
// RATINGS DE USUARIOS (públicos, separados del oficial)
// ============================================
model UserRating {
  id        Int      @id @default(autoincrement())
  category  String   // mismas categorías que Rating
  score     Int      // 1-10
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  seriesId Int
  series   Series @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@unique([userId, seriesId, category])
}

// ============================================
// COMENTARIOS
// ============================================
model Comment {
  id            Int       @id @default(autoincrement())
  content       String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Usuario que comentó (opcional para preservar comentarios existentes)
  userId        String?
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Puede ser comentario de Serie, Temporada o Episodio
  seriesId      Int?
  series        Series?   @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  seasonId      Int?
  season        Season?   @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  episodeId     Int?
  episode       Episode?  @relation(fields: [episodeId], references: [id], onDelete: Cascade)
}

// ============================================
// ESTADO DE VISUALIZACIÓN (por usuario)
// ============================================
enum WatchStatus {
  SIN_VER
  VIENDO
  VISTA
  ABANDONADA
  RETOMAR
}

model ViewStatus {
  id                Int         @id @default(autoincrement())
  status            WatchStatus @default(SIN_VER)
  watchedDate       DateTime?
  lastWatchedAt     DateTime? // Última vez que se vio
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Usuario (opcional para preservar datos existentes)
  userId        String?
  user          User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Puede ser estado de Serie, Temporada o Episodio
  seriesId      Int?
  series        Series?   @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  seasonId      Int?
  season        Season?   @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  episodeId     Int?
  episode       Episode?  @relation("EpisodeViewStatus", fields: [episodeId], references: [id], onDelete: Cascade)

  @@unique([userId, seriesId])
  @@unique([userId, seasonId])
  @@unique([userId, episodeId])
}

// ============================================
// FEATURE REQUESTS / BUGS / IDEAS
// ============================================
model FeatureRequest {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  type        String   // "bug", "feature", "idea"
  status      String   @default("pendiente") // "pendiente", "en_progreso", "completado", "descartado"
  priority    String   @default("media") // "baja", "media", "alta"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  votes  FeatureVote[]
  images FeatureRequestImage[]
}

model FeatureRequestImage {
  id               Int            @id @default(autoincrement())
  url              String
  createdAt        DateTime       @default(now())
  featureRequestId Int
  featureRequest   FeatureRequest @relation(fields: [featureRequestId], references: [id], onDelete: Cascade)
}

model FeatureVote {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  userId           String
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  featureRequestId Int
  featureRequest   FeatureRequest @relation(fields: [featureRequestId], references: [id], onDelete: Cascade)

  @@unique([userId, featureRequestId])
}

// ============================================
// ACCESS LOGS
// ============================================
model AccessLog {
  id        Int      @id @default(autoincrement())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    String   // PAGE_VIEW, LOGIN, LOGOUT, CREATE, UPDATE, DELETE
  path      String   // URL o recurso
  method    String?  // GET, POST, PUT, DELETE
  ip        String?
  userAgent String?
  metadata  String?  // JSON string con detalles extra
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([userId])
}

// ============================================
// BANNED IPS
// ============================================
model BannedIp {
  id        Int      @id @default(autoincrement())
  ip        String   @unique
  reason    String?
  createdAt DateTime @default(now())
}

// ============================================
// SITIOS DE INTERES
// ============================================
model RecommendedSite {
  id          Int      @id @default(autoincrement())
  name        String
  url         String
  description String?
  category    String?  // "noticias", "comunidad", "streaming", "info", "otro"
  language    String?  // "ES", "EN", "TH", "JP", "KR", "Multi", etc.
  imageUrl    String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// SITIOS SUGERIDOS POR LA COMUNIDAD
// ============================================
model SuggestedSite {
  id          Int      @id @default(autoincrement())
  name        String
  url         String
  description String?
  category    String?
  language    String?
  status      String   @default("pendiente") // "pendiente", "aprobado", "rechazado"
  adminNote   String?
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// DONDE VER (WATCH LINKS)
// ============================================
model WatchLink {
  id       Int     @id @default(autoincrement())
  platform String  // "YouTube", "Viki", "iQIYI", "WeTV", "Netflix", etc.
  url      String
  official Boolean @default(true)

  seriesId Int
  series   Series  @relation(fields: [seriesId], references: [id], onDelete: Cascade)
}

// ============================================
// CONTENIDO EMBEBIBLE
// ============================================
model EmbeddableContent {
  id           Int      @id @default(autoincrement())
  title        String
  description  String?
  platform     String   // "YouTube", "Bilibili", "Vimeo", "Dailymotion", "TikTok", "Instagram", "Twitter", "Spotify"
  url          String
  videoId      String?  // ID extraído automáticamente
  category     String   @default("other") // "trailer", "ost", "interview", "clip", "behind_scenes", "live", "other"
  language     String?
  thumbnailUrl String?
  channelName  String?
  channelUrl   String?
  official     Boolean  @default(true)
  sortOrder    Int      @default(0)
  featured     Boolean  @default(false)
  seriesId     Int?
  series       Series?  @relation(fields: [seriesId], references: [id], onDelete: SetNull)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
